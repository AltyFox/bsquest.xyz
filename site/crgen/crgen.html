<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CrashReporter AutoConfig</title>
  <script src="./dist/jszip.min.js"></script>
  <script src="./fileSaver.js"></script>
  <script type="text/javascript" src="delaunay.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e2f;
      color: #fff;
      text-align: center;
      padding: 2rem;
    }

    h1 {
      margin-bottom: 1rem;
    }

    .button {
      background: #4a90e2;
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      margin: 0.5rem;
      border-radius: 10px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .button:hover {
      background: #357ab8;
    }
  </style>
</head>
<body>
  <h1>Please select your game version, <span id="username"></span>.</h1>
  <div id="button-area"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let username = urlParams.get('usr') || "UsernameForgotten!";
    let fullcrash = urlParams.has('fc') ? urlParams.get('fc') : true;
    let log = urlParams.has('log') ? urlParams.get('log') : true;

    document.getElementById("username").textContent = username;

    const currentDate = new Date();
    const formattedDate = `${String(currentDate.getFullYear()).slice(-2)}.${currentDate.getMonth() + 1}.${currentDate.getDate()}`;

    var modInfo = {
      "_QPVersion": "0.1.1",
      "name": "CrashReporter AutoConfig",
      "id": "cr_gen",
      "author": "Alteran",
      "version": formattedDate,
      "packageId": "com.beatgames.beatsaber",
      "packageVersion": "INVALID, PLEASE REPORT TO @ALTERAN",
      "description": `Generated QMod for automatic CrashReporter configuration, generated for ${username}`,
      "coverImage": "cover.png",
      "dependencies": [{
        "version": "0.0.0",
        "id": "crashreporter",
        "downloadIfMissing": "nope"
      }],
      "fileCopies": [{
        "name": "CrashReporter.json",
        "destination": "sdcard/ModData/com.beatgames.beatsaber/Configs/CrashReporter.json"
      }],
      "copyExtensions": []
    };

    var crashReporter = {
      "Enabled": true,
      "FullCrash": Boolean(fullcrash),
      "Log": Boolean(log),
      "UserId": username,
      "Url": "https://analyzer.questmodding.com/api/upload"
    };

    let iconBlob = null;
    fetch('./cover.png')
      .then(res => res.blob())
      .then(blob => iconBlob = blob)
      .catch(err => console.error('cover.png error:', err));

    let qmodName = `CrashReporterAutoConfig_${username}.qmod`;

    function generateQMOD() {
      const zip = new JSZip();
      zip.file("mod.json", JSON.stringify(modInfo));
      zip.file("CrashReporter.json", JSON.stringify(crashReporter));
      if (iconBlob) zip.file("cover.png", iconBlob);
      zip.generateAsync({ type: "blob", mimeType: "application/qmod" })
        .then(content => saveAs(content, qmodName));
    }

    fetch("https://mods.bsquest.xyz/mods.json")
      .then(response => response.json())
      .then(data => {
        const sorted = Object.keys(data).sort().reduce((acc, key) => {
          acc[key] = data[key];
          return acc;
        }, {});

        for (let pkg in sorted) {
          const mods = sorted[pkg];
          const crMod = mods.find(mod => mod.id === "crashreporter");
          if (!crMod) continue;

          const btn = document.createElement("button");
          btn.className = "button";
          btn.textContent = pkg.split('_')[0];
          btn.onclick = () => {
            modInfo.packageVersion = pkg;
            modInfo.modloader = crMod.modloader || "QuestLoader";
            modInfo.dependencies[0].version = crMod.version;
            modInfo.dependencies[0].downloadIfMissing = crMod.download;
            qmodName = `CrashReporterAutoConfig_${pkg.split('_')[0]}_${username}.qmod`;
            generateQMOD();
          };
          document.getElementById("button-area").appendChild(btn);
        }
      })
      .catch(err => console.error("Failed to fetch mods.json:", err));
  </script>
</body>
</html>
